<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WS Chat Test (2 Token)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f6f6; margin: 0; padding: 20px; }
    .wrap { max-width: 900px; margin: 0 auto; background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .panel { border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; background: #fafafa; }
    h2 { margin: 0 0 8px; }
    input, button, textarea { width: 100%; padding: 8px; margin-top: 8px; }
    .log { height: 160px; overflow: auto; background: #fff; border: 1px solid #ddd; padding: 8px; font-size: 12px; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>WebSocket Chat Test (2 Token)</h2>
    <div class="muted">Eslatma: JWT token query param bilan ishlashi uchun backendda token middleware bo‚Äòlishi kerak.</div>

    <div class="panel">
      <label>Conversation ID</label>
      <input id="conversationId" value="49" />
      <label>Host</label>
      <input id="host" value="wss://api.iqmath.uz" />
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="panel">
        <h3>User A</h3>
        <label>Token 1</label>
        <textarea id="token1" rows="4"></textarea>
        <button onclick="connectA()">Ulash</button>
        <div class="log" id="logA"></div>
        <input id="msgA" placeholder="A dan yuborish..." />
        <button onclick="sendA()">Yuborish</button>
      </div>

      <div class="panel">
        <h3>User B</h3>
        <label>Token 2</label>
        <textarea id="token2" rows="4"></textarea>
        <button onclick="connectB()">Ulash</button>
        <div class="log" id="logB"></div>
        <input id="msgB" placeholder="B dan yuborish..." />
        <button onclick="sendB()">Yuborish</button>
      </div>
    </div>
  </div>

  <script>
    let wsA = null;
    let wsB = null;

    function buildUrl(token) {
      const host = document.getElementById("host").value.trim();
      const conversationId = document.getElementById("conversationId").value.trim();
      let url = `${host}/ws/chat/${conversationId}/`;
      if (token) {
        url += `?token=${encodeURIComponent(token)}`;
      }
      return url;
    }

    function log(id, msg) {
      const el = document.getElementById(id);
      el.innerHTML += msg + "<br>";
      el.scrollTop = el.scrollHeight;
    }

    function connectA() {
      const token = document.getElementById("token1").value.trim();
      wsA = new WebSocket(buildUrl(token));
      wsA.onopen = () => log("logA", "‚úÖ Ulandi");
      wsA.onmessage = (e) => log("logA", "üì© " + e.data);
      wsA.onerror = (e) => log("logA", "‚ùå Xato: " + e.type);
      wsA.onclose = (e) => log("logA", `üîå Yopildi: code=${e.code}`);
    }

    function connectB() {
      const token = document.getElementById("token2").value.trim();
      wsB = new WebSocket(buildUrl(token));
      wsB.onopen = () => log("logB", "‚úÖ Ulandi");
      wsB.onmessage = (e) => log("logB", "üì© " + e.data);
      wsB.onerror = (e) => log("logB", "‚ùå Xato: " + e.type);
      wsB.onclose = (e) => log("logB", `üîå Yopildi: code=${e.code}`);
    }

    function sendA() {
      if (!wsA || wsA.readyState !== WebSocket.OPEN) {
        log("logA", "‚ùå Ulanmagan");
        return;
      }
      const text = document.getElementById("msgA").value.trim();
      if (!text) return;
      wsA.send(JSON.stringify({ text }));
      document.getElementById("msgA").value = "";
    }

    function sendB() {
      if (!wsB || wsB.readyState !== WebSocket.OPEN) {
        log("logB", "‚ùå Ulanmagan");
        return;
      }
      const text = document.getElementById("msgB").value.trim();
      if (!text) return;
      wsB.send(JSON.stringify({ text }));
      document.getElementById("msgB").value = "";
    }
  </script>
</body>
</html>
