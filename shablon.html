<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Teacher Chat</title>
    <style>
        body { font-family: Arial; display: flex; height: 100vh; margin: 0; }
        #chat-list { width: 30%; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
        #messages-box { width: 70%; display: flex; flex-direction: column; }
        #messages { flex: 1; padding: 10px; overflow-y: auto; }
        #input-box { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        #input-box input { flex: 1; padding: 8px; }
        #input-box button { margin-left: 10px; padding: 8px 20px; }
        .chat-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .chat-item:hover { background: #f2f2f2; }
        .message { margin: 5px 0; padding: 10px; border-radius: 5px; max-width: 70%; }
        .me { background: #d1ffd1; margin-left: auto; }
        .other { background: #f0f0f0; margin-right: auto; }
    </style>
</head>
<body>

<div id="chat-list">
    <h3>Chatlar</h3>
    <div id="chat-items"></div>
</div>

<div id="messages-box">
    <div id="messages"></div>
    <div id="input-box">
        <input type="text" id="messageInput" placeholder="Xabar yozing..." />
        <button onclick="sendMessage()">Yuborish</button>
    </div>
</div>

<script>
    const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYzOTM0MTA5LCJpYXQiOjE3NjM4ODczMDksImp0aSI6ImJlYTI0Y2RlNzhiYTRhMTNhOGRhNTA1OTliZTZjNmEwIiwidXNlcl9pZCI6NSwidGVhY2hlcl9pZCI6NH0.0cddiXMtvMLS3ksxHg71evapQcQSRk3Z4B_18RLGzIU";

    let currentConversation = null;

    // 1) CHATLAR RO‘YXATI
    function loadChats() {
        fetch("https://api.iqmath.uz/api/v1/func_chat/chat/teacher/", {
            headers: { "Authorization": "Bearer " + TOKEN }
        })
        .then(res => res.json())
        .then(data => {
            let box = document.getElementById("chat-items");
            box.innerHTML = "";
            data.forEach(chat => {
                box.innerHTML += `
                    <div class="chat-item" onclick="openChat(${chat.id})">
                        <b>${chat.other_user_name}</b><br>
                        ${chat.last_message ?? ""}
                    </div>
                `;
            });
        });
    }

    // 2) CHATNI OCHISH
    function openChat(id) {
        currentConversation = id;
        fetch(`https://api.iqmath.uz/api/v1/func_chat/chat/${id}/messages/`, {
            headers: { "Authorization": "Bearer " + TOKEN }
        })
        .then(res => res.json())
        .then(data => {
            let box = document.getElementById("messages");
            box.innerHTML = "";

            data.messages.forEach(msg => {
                box.innerHTML += `
                    <div class="message ${msg.sender_id === getUserId() ? 'me' : 'other'}">
                        ${msg.text}
                    </div>
                `;
            });

            box.scrollTop = box.scrollHeight;
        });
    }

    function getUserId() {
        // Token ichidan teacher user_id ni decode qilish oson, lekin soddaroq usul:
        return 5;  // Sen aytgan token bo‘yicha teacher user_id = 5
    }

    // 3) XABAR YUBORISH
    function sendMessage() {
        let text = document.getElementById("messageInput").value;
        if (!text || !currentConversation) return;

        fetch(`https://api.iqmath.uz/api/v1/func_chat/chat/${currentConversation}/send/`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + TOKEN
            },
            body: new FormData(document.querySelector("#input-box"))
        });

        let fd = new FormData();
        fd.append("text", text);

        fetch(`https://api.iqmath.uz/api/v1/func_chat/chat/${currentConversation}/send/`, {
            method: "POST",
            headers: { "Authorization": "Bearer " + TOKEN },
            body: fd
        })
        .then(res => res.json())
        .then(msg => {
            document.getElementById("messageInput").value = "";
            openChat(currentConversation);
        });
    }

    loadChats();
</script>

</body>
</html>
